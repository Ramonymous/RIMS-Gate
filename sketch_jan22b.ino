// Definisi Logika Relay (Active Low)
#define RELAY_ON  LOW
#define RELAY_OFF HIGH

// Timeout dalam milidetik (5 detik)
const unsigned long LIGHT_TIMEOUT = 5000;
unsigned long lastTurnOnTime = 0;
bool isLightActive = false;

// Struktur data untuk memetakan PN ke Pin
struct PickLight {
  String pn;
  int pin;
};

// Daftar Part Number dan Pin yang sesuai
PickLight lights[] = {
  {"64578-I6000", D1}, {"64556-I6000", D2}, {"64818-I6000", D3},
  {"64572-I6000", D4}, {"64554-I6000", D5}, {"64518-I6000", D6},
  {"64532-I6000", D7}, {"66796-I6000", D8}, {"64458-I6000", D1},
  {"64534-I6000", D2}, {"64574-I6000", D3}, {"64588-I6000", D4},
  {"64542-I6000", D5}, {"64828-I6000", D6}, {"64584-I6000", D7},
  {"64566-I6000", D8}, {"64464-I6000", D1}, {"64546-I6000", D2},
  {"64582-I6000", D3}, {"64528-I6000", D4}, {"66796-I6900", D5},
  {"64564-I6000", D6}, {"64312-I6950", D7}, {"643B6-I6900", D8},
  {"64364-I6900", D1}, {"643A6-I6000", D2}, {"64364-I6000", D3},
  {"64332-I6000", D4}, {"64358-I6000", D5}, {"64354-I6000", D6},
  {"71274-I6000", D7}, {"66786-I6000", D8}, {"64378-I6000", D1},
  {"64356-I6000", D2}, {"64318-I6900", D3}, {"64332-I6900", D4},
  {"64346-I6000", D5}, {"64328-I6000", D6}, {"66786-I6900", D7},
  {"64354-I6900", D8}, {"643D2-I6000", D1}, {"64312-I6900", D2},
  {"64388-I6900", D3}, {"643G4-I6900", D4}, {"64368-I6900", D5},
  {"64318-I6000", D6}, {"64446-I6000", D7}, {"64366-I6000", D8},
  {"64438-I6000", D1}, {"64526-I6000", D2}, {"64448-I6900", D3},
  {"64516-I6000", D4}, {"64156-I6500", D5}, {"64172-I6000", D6},
  {"64118-I6000", D7}, {"641C4-I6000", D8}, {"641A6-I6000", D1},
  {"64634-I6000", D2}, {"64156-I6000", D3}, {"641E8-I6000", D4},
  {"641A2-I6000", D5}, {"64174-I6000", D6}, {"641A4-I6000", D7},
  {"64576-I6000", D8}, {"641B4-I6000", D1}, {"64128-I6000", D2},
  {"641B6-I6000", D3}, {"64998-I6000", D4}, {"64644-I6000", D5},
  {"641B2-I6000", D6}, {"64182-I6000", D7}, {"64586-I6000", D8},
  {"641D4-I6000", D1}, {"64184-I6000", D2}, {"64166-I6000", D3},
  {"64638-I6000", D4}, {"64756-I6000", D5}, {"64638-I6900", D6},
  {"64658-I6000", D7}, {"64672-I6900", D8}, {"64732-I6000", D1},
  {"64654-I6000", D2}, {"64656-I6000", D3}, {"64668-I6000", D4},
  {"64648-I6900", D5}, {"64766-I6900", D6}, {"64682-I6000", D7},
  {"64668-I6900", D8}, {"64664-I6900", D1}, {"64742-I6000", D2},
  {"64648-I6000", D3}, {"64312-I6000", D4}, {"64578-I6500", D5},
  {"64818-I6500", D6}, {"64578-I6501", D7}, {"64828-I6500", D8},
  {"64588-I6500", D1}, {"64464-I6500", D2}, {"64588-I6501", D3},
  {"64335-I6960", D4}, {"641A2-I6500", D5}, {"641E8-I6500", D6},
  {"64172-I6500", D7}, {"64118-I6500", D8}, {"64166-I6500", D1},
  {"64128-I6500", D2}, {"641B2-I6500", D3}, {"641F8-I6500", D4},
  {"64182-I6500", D5}, {"641C4-I6500", D6}, {"641D4-I6500", D7},
  {"64159-I6500", D8}, {"64169-I6500", D1}, {"64494-I7000", D2},
  {"64772-I7000", D3}, {"64532-I7000", D4}, {"64534-I7000", D5},
  {"64574-I7000", D6}, {"64554-I7000", D7}, {"64518-I7000", D8},
  {"64572-I7000", D1}, {"645C8-I7000", D2}, {"64556-I7000", D3},
  {"64578-I7000", D4}, {"64818-I7000", D5}, {"64458-I7000", D6},
  {"64496-I7000", D7}, {"64528-I7000", D8}, {"64584-I7000", D1},
  {"64588-I7000", D2}, {"64582-I7000", D3}, {"64542-I7000", D4},
  {"64546-I7000", D5}, {"64782-I7000", D6}, {"64828-I7000", D2},
  {"645D8-I7000", D8}, {"64564-I7000", D1}, {"64468-I7000", D2},
  {"64566-I7000", D3}, {"64522-I7000", D4}, {"64354-I7900", D5},
  {"64364-I7900", D6}, {"64318-I7900", D7}, {"643B6-I7900", D8},
  {"64332-I7900/950", D1}, {"64364-I7000", D2}, {"64346-I7000", D3},
  {"64388-I7900", D4}, {"64318-I7000", D5}, {"64354-I7000", D6},
  {"643A6-I7000", D7}, {"64332-I7000/050", D8}, {"64378-I7000", D1},
  {"643D2-I7000", D2}, {"64312-I7950", D3}, {"64312-I7050", D4},
  {"64312-I7000", D5}, {"64312-I7900", D6}, {"64516-I7900", D7},
  {"64526-I7900", D8}, {"64344-I7900", D1}, {"64334-I7900", D2},
  {"64516-I7000", D3}, {"64344-I7000", D4}, {"64526-I7000", D5},
  {"64334-I7000", D6}, {"641A2-I7000", D7}, {"641C8-I7000", D8},
  {"641A4-I7000", D1}, {"64172-I7000", D2}, {"641C2-I7000", D3},
  {"64576-I7000", D4}, {"64176-I7000", D5}, {"64156-I7000", D6},
  {"641B2-I7000", D7}, {"641D8-I7000", D8}, {"641B4-I7000", D1},
  {"64182-I7000", D2}, {"641C4-I7000", D3}, {"641D4-I7000", D4},
  {"641D2-I7000", D5}, {"64586-I7000", D6}, {"64166-I7000", D7},
  {"64186-I7000", D8}, {"64728-I7000", D1}, {"64638-I7900", D2},
  {"64638-I7000", D3}, {"64654-I7000", D4}, {"64658-I7900", D5},
  {"64672-I7900", D6}, {"64732-I7000", D7}, {"64356-I7000", D8},
  {"64658-I7000", D1}, {"71274-I7000", D2}, {"64668-I7900", D3},
  {"64742-I7000", D4}, {"64648-I7000", D5}, {"64668-I7000", D6},
  {"64682-I7000", D7}, {"64664-I7900", D8}, {"64366-I7000", D1},
  {"64766-I7900", D2}, {"64648-I7900", D3}, {"71284-I7000", D4},
  {"64494-I7500", D5}, {"64496-I7500", D6}, {"641E2-I7550", D7},
  {"641E4-I7550", D8}, {"64118-I7500", D1}, {"641C2-I7550", D2},
  {"641A2-I7500", D3}, {"641E6-I7500", D4}, {"64172-I7500", D5},
  {"64176-I7550", D6}, {"641F2-I7550", D7}, {"641D2-I7550", D8},
  {"641F4-I7550", D1}, {"64128-I7500", D2}, {"641B2-I7500", D3},
  {"641F6-I7500", D4}, {"64182-I7500", D5}, {"64186-I7550", D6},
  {"641C4-I7500", D7}, {"64512-I7000", D8}, {"64538-I7000", D1},
  {"64514-I7000", D1}, {"64594-I7900", D3}, {"64352-I7900", D4},
  {"64338-I7900", D5}, {"64338-I7000", D6}, {"64352-I7000", D7},
  {"64326-I7000", D8}, {"64374-I7000", D1}, {"646A4-I7000", D2},
  {"64612-I7000", D3}, {"647A4-I7000", D4}, {"64674-I7000", D5},
  {"64632-I7000", D6}, {"64618-I7000", D7}, {"64616-I7000", D8},
  {"64416-I7000", D1}, {"64722-I7000", D2}, {"64814-I7000", D3},
  {"647A2-I7000", D4}, {"64736-I7000", D5}, {"64718-I7000", D6},
  {"646A2-I7000", D7}, {"64836-I7000", D8}, {"64812-I7000", D1},
  {"64684-I7000", D2}, {"64724-I7000", D3}, {"64642-I7000", D4},
  {"64622-I7000", D5}, {"64626-I7000", D6}, {"64426-I7000", D7},
  {"64846-I7000", D8}, {"64822-I7000", D1}, {"646B2-I7000", D2},
  {"64844-I7000", D3}, {"64746-I7000", D4}, {"64714-I7000", D5},
  {"646B4-I7000", D6}, {"64414-I7000", D7}, {"64424-I7000", D8}
};

const int lightsCount = sizeof(lights) / sizeof(lights[0]);

void allLightsOff() {
  digitalWrite(D1, RELAY_OFF);
  digitalWrite(D2, RELAY_OFF);
  digitalWrite(D3, RELAY_OFF);
  digitalWrite(D4, RELAY_OFF);
  digitalWrite(D5, RELAY_OFF);
  digitalWrite(D6, RELAY_OFF);
  digitalWrite(D7, RELAY_OFF);
  digitalWrite(D8, RELAY_OFF);
  isLightActive = false;
}

void setup() {
  Serial.begin(9600);
  int pins[] = {D1, D2, D3, D4, D5, D6, D7, D8};
  for (int i = 0; i < 8; i++) {
    pinMode(pins[i], OUTPUT);
    digitalWrite(pins[i], RELAY_OFF);
  }
}

void loop() {
  // 1. Cek timeout (jika lampu sedang menyala)
  if (isLightActive) {
    if (millis() - lastTurnOnTime >= LIGHT_TIMEOUT) {
      allLightsOff();
      Serial.println("Timeout: Lampu otomatis dimatikan.");
    }
  }

  // 2. Cek perintah baru dari Serial
  if (Serial.available()) {
    String incomingPN = Serial.readStringUntil('\n');
    incomingPN.trim();

    if (incomingPN != "") {
      allLightsOff(); // Matikan dulu yang lama

      bool found = false;
      for (int i = 0; i < lightsCount; i++) {
        if (incomingPN == lights[i].pn) {
          digitalWrite(lights[i].pin, RELAY_ON);
          
          // Tandai waktu nyala dan status aktif
          lastTurnOnTime = millis();
          isLightActive = true;
          
          Serial.print("Lampu menyala untuk: ");
          Serial.println(lights[i].pn);
          found = true;
          break;
        }
      }
      
      if (!found) {
        Serial.print("PN tidak terdaftar: ");
        Serial.println(incomingPN);
      }
    }
  }
}